{% extends "base.html" %}
{% block content %}
<div class="max-w-md mx-auto">
  <div class="rounded-2xl border border-gray-200 bg-white p-6 sm:p-8 shadow-sm">
    <h2 class="text-2xl font-semibold tracking-tight">Login with OTP</h2>
    <p class="text-sm text-gray-600 mt-1">Enter your email, we’ll send a one-time password.</p>

    <!-- IMPORTANT: onsubmit="return false" prevents full page reload -->
    <form id="loginForm" class="mt-6 space-y-5" onsubmit="return false" novalidate>
      <div class="space-y-2">
        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
        <input id="email" type="email" required autocomplete="email"
               class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:border-emerald-500 focus:ring-emerald-500" />
        <p id="emailHelp" class="text-xs text-gray-500">Press Enter to send OTP.</p>
      </div>

      <div id="otpRow" class="hidden space-y-2">
        <label for="otp" class="block text-sm font-medium text-gray-700">OTP</label>
        <input id="otp" type="text" inputmode="numeric" autocomplete="one-time-code"
               class="w-full rounded-xl border border-gray-300 px-3 py-2 focus:border-emerald-500 focus:ring-emerald-500" />
      </div>

      <div class="flex flex-col sm:flex-row gap-3">
        <!-- type="button" ensures this never submits the form -->
        <button id="sendBtn" type="button"
                class="inline-flex justify-center px-4 py-2.5 rounded-xl bg-gray-900 text-white text-sm font-medium hover:bg-black disabled:opacity-60">
          Send OTP
        </button>
        <button id="submitBtn" type="button"
                class="hidden inline-flex justify-center px-4 py-2.5 rounded-xl bg-emerald-600 text-white text-sm font-medium hover:bg-emerald-700 disabled:opacity-60">
          Login
        </button>
      </div>
    </form>

    <pre id="out" class="mt-5 text-xs bg-gray-50 p-3 rounded-lg overflow-auto max-h-48 hidden"></pre>
<!-- 
    <p class="text-sm mt-6 text-gray-700">
      Don’t have an account?
      <a href="/register" class="text-emerald-700 font-medium hover:underline">Register</a>
    </p> -->
  </div>
</div>

<script>
(function() {
  const out = document.getElementById('out');
  const otpRow = document.getElementById('otpRow');
  const submitBtn = document.getElementById('submitBtn');
  const sendBtn = document.getElementById('sendBtn');
  const emailEl = document.getElementById('email');
  const otpEl = document.getElementById('otp');


  function busy(btn, text) {
    btn.dataset._old = btn.textContent;
    btn.textContent = text;
    btn.disabled = true;
  }
  function idle(btn) {
    btn.textContent = btn.dataset._old || btn.textContent;
    btn.disabled = false;
  }

  // Prevent Enter from submitting the entire form before OTP
  emailEl.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      sendBtn.click();
    }
  });

  sendBtn.onclick = async () => {
    const email = emailEl.value.trim();
    if (!email) return toast("Please enter email");
    busy(sendBtn, "Sending…");
    try {
      const r = await fetch('/api/auth/send-otp', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ email, purpose: 'login' })
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok) throw new Error(j.detail || 'Failed to send OTP');
      otpRow.classList.remove('hidden');
      submitBtn.classList.remove('hidden');
      toast('OTP sent!');
      otpEl.focus();
    } catch (err) {
      toast(err.message || 'Failed to send OTP');
    } finally {
      idle(sendBtn);
    }
  };

  submitBtn.onclick = async () => {
    const email = emailEl.value.trim();
    const otp = otpEl.value.trim();
    if (!otp) return toast("Enter OTP");
    busy(submitBtn, "Logging in…");
    try {
      const r = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ email, otp })
      });
      const j = await r.json().catch(()=>({}));
      if (!r.ok) throw new Error(j.detail || 'Login failed');
      // Keep for SPA fetches (cookies are already set by server)
      localStorage.setItem('access_token', j.access_token);
      localStorage.setItem('refresh_token', j.refresh_token);
      toast('Welcome back!');
      window.location.href = '/';
    } catch (err) {
      toast(err.message || 'Login failed');
    } finally {
      idle(submitBtn);
    }
  };
})();
</script>
{% endblock %}
